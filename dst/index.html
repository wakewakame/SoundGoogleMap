<!DOCTYPE html>
<html>
	<head>
		<!-- Select Text Encode -->
		<meta content="ja" http-equiv="Content-Language" />
		<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
		<!-- Set Resolution -->
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!-- full screen on iOS browser -->
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<!-- title -->
		<title>NodeShader</title>

		<script type="module">window._ = {};</script>
		<script type="module" src="./main.js"></script>
		<script type="module">
			import { Graphics } from "./hydrangea.js";

			let g;
			let fftTextureGenerator;
			let shape, shader;
			let time = 0.0;
			let fps = 60.0;

			document.addEventListener("DOMContentLoaded", (event) => {
				g = new Graphics(document.getElementById("canvas"));

				fftTextureGenerator = new window.FftTextureGenerator(g.gapp.gl);

				shape = g.createShape();
				shape.beginShape();
				for(let i = 0; i < 1024; i++) shape.vertex(i / 1023, 0.0, 0.0);
				shape.endShape();

				shader = g.createShader();
				shader.loadShader(`
                    precision highp float;
                    attribute vec3 position;
                    attribute vec2 uv;
                    attribute vec4 color;
                    uniform mat4 matrix;
                    varying vec2 vUv;
                    varying vec4 vColor;

                    uniform sampler2D texture;

                    void main(void) {
                        vUv = uv;
                        vColor = color;
                        gl_Position = vec4(
                        	position.x * 2.0 - 1.0,
                        	texture2D(texture, vec2(position.x, 0.0)).r * 0.01 - 0.5,
                        	0.0,
                        	1.0
                        );
                    }
                `,
                `
                    precision highp float;
                    varying vec2 vUv;
                    varying vec4 vColor;

                    void main(void){
                        gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
                    }
                `);

				time = 0.0;

				loop();
			});

			const loop = () => {
				time += 1.0 / fps; // Count time

				g.clear();
				g.shader(g.shaders.normal);
				g.fill(1, 1, 1, 1); g.stroke(0, 0, 0, 0);
				g.rect(0, 0, g.width, g.height);

				fftTextureGenerator.update();
				shader.set("texture", fftTextureGenerator.fftResultFrame.texture);
				g.shader(shader);
				g.shape(shape);

				g.render();

				setTimeout(loop, 1000.0 / fps);
			}
		</script>
	</head>
	<body>
		<canvas id="canvas" width="1024" height="300"></canvas>
	</body>
</html>