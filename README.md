# 用意するもの
- Google Chrome
- Google Map

# コンパイル方法
`./node_modules/.bin/webpack`を実行する。
`./dst/main.js`が生成される。

# 大雑把な流れ
Google Mapは描画処理をするjavascriptの読み込みに<script>タグのsrc機能を使用していない。
XMLHttpRequestでjavascriptのテキストテータを取得し、それを元に<script>タグを追記している。
XMLHttpRequestの関数を呼び出している部分を書き換えることにより、描画処理をイジって遊ぶことができる。
今回はWebGLのシェーダを書き換えてみることにした。
また、Google Mapのjavascriptは(多分)毎日変更され、その都度変数名が変わる。
その為、今回はソースコードを置き換えるのではなく、一部の文字列を正規表現で置換する手法を取った。

# 手順
1. Google Chromeを開き、`Ctrl + Shift + I`でデベロッパーツールを開く。
2. その状態でGoogle Mapを開き、左下のボタンで航空写真の表示に切り替える。
3. デベロッパーツールのSourcesタブを開き、左のファイルツリーから`top/www.google.com/maps/_/js/...`と辿ってゆき、`rs=ACT90oFFBq5f9N5jLcmVHvVfMlaNDdJNQA`を見つけて開く。
4. 開かれたソースコードの左下にある`{}`マークをクリックし、ソースコードのインデントを自動整理する。
5. `Ctrl+F`でソースコードの検索バーを表示し、`responseText`という文字列を検索する。
6. その検索結果が1件のみであることを確認し、その少し上の行にある`_.XXX = function(a)`の`XXX`の部分をメモしておく。
7. 6.で見つけた関数定義`_.XXX = function(a) { --(中略)-- };`の最終行の次の行の行番号をクリックし、ブレークポイントを張る。
8. その状態で`Ctrl+R`でリロードする。
9. ブレークポイントで処理が一時停止されるまで待つ。
10. デベロッパーツールのConsoleタブを開き、このソースコードを張り付けて実行する。ただし、XXXの箇所は先ほどメモした文字に置き換える。
11. 画面に表示されている`Paused in debugger`の右側の再生ボタンを押し、ブレークポイントから抜ける。

# 詳細な処理内容
GoogleMapはjsファイルをXMLHttpReqestで取得し、そのテキストをjsとして実行している。
XMLHttpRequestでテキストデータを取得する関数をフックすることにより、GoogleMapのプログラムを書き換えることが可能になる。

## GoogleMapの改造内容

### 1. 常に60fpsでレンダリングされるようにする
GoogleMapは頂点データの更新や、カメラアングルが変更されない限りはレンダリングを行わない。
そのため、GoogleMapをレンダリングする関数を見つけ、フレームレートが60より高くなったり低くなったりしないように変更した。
具体的には、レンダリングをしている関数部分を変更し、レンダリングすると同時にレンダリング時刻を、こちらが用意した変数に記録するように変更した。
さらに、setInterval関数により、最後にレンダリングされた時間と現在時刻の差が一定以上ならば、レンダリングを行うようにして、継続的にレンダリングされるよううにした。

### 2. シェーダの書き換え
GoogleMapは描画の一部にWebGLを用いている。
そこで、シェーダをコンパイルする関数をフックすることにより、GoogleMapで使用されるすべてのシェーダを書き換えられるように変更した。
また、GoogleMapのシェーダは、同一のソースコードでも、複数回コンパイルされることがある。
これはシェーダ内に存在する#ifdef XXXなどを有効にしたり無効にしたりするためである。
これを用いて建物を3D描画しているシェーダを書き換えた。
建物を表示しているシェーダは2回コンパイルされる。
1つ目のシェーダは「カメラの画角が真下から45度までの範囲のとき」という条件で使用される。
2つ目のシェーダは「カメラの画角が水平線から45度までの範囲のとき」という条件で使用される。
1つ目のシェーダには先頭に#define_a;という行が追加されており、これにより#ifdef _a内にあるuniform mat4 u;という変数が有効になる。
この変数attributeで与えられる頂点を地球の中心を原点とした座標に変換するための行列である。
どちらのシェーダを使用するかはisVisible関数が返す値によって切り替えられている。
そのため、isVisible関数を書き換えることにより、シェーダ2のみを使用するように変更した。

### 3. 任意のuniform変数を更新できるように変更
GoogleMapはレンダリングを行うときにdrawElement関数を用いる。
その関数が呼ばれている少し前の行に、こちらが定義した関数を呼ばせるように変更した。
これにより、レンダリングする直前のタイミングでuniform変数の更新が行えるようになった。