![demo](https://github.com/wakewakame/SoundGoogleMap/blob/master/demo/demo.gif?raw=true)  

# 用意するもの
- Google Chrome

# 使い方
chromeで`chrome://extensions/`を開く。  
`パッケージ化されていない拡張機能を読み込む`を押す。  
このフォルダ内のdstフォルダを選択する。  

# コンパイル方法
`npm install`を実行する。  
`./node_modules/.bin/webpack`を実行する。  
`./dst/main.js`が生成される。  

# 仕組み
GoogleMapはjsファイルを`XMLHttpReqest`で取得し、そのテキストをjsとして実行している。  
`XMLHttpRequest`でテキストデータを取得する関数をフックすることにより、GoogleMapのプログラムを書き換えることが可能になる。  
今回はWebGLのシェーダを書き換えてみることにした。  
また、Google Mapのjavascriptは(多分)毎日変更され、その都度変数名が変わる。  
その為、今回はソースコードを置き換えるのではなく、一部の文字列を正規表現で置換する手法を取った。  

# GoogleMapの改造内容
## 1. 常に60fpsでレンダリングされるようにする
GoogleMapは頂点データの更新や、カメラアングルが変更されない限りはレンダリングを行わない。  
そのため、GoogleMapをレンダリングする関数を見つけ、フレームレートが60より高くなったり低くなったりしないように変更した。  
具体的には、レンダリングをしている関数部分を変更し、レンダリングすると同時にレンダリング時刻を、こちらが用意した変数に記録するように変更した。  
さらに、`setInterval`関数により、最後にレンダリングされた時間と現在時刻の差が一定以上ならば、レンダリングを行うようにして、継続的にレンダリングされるよううにした。  

## 2. シェーダの書き換え
GoogleMapは描画の一部にWebGLを用いている。  
そこで、シェーダをコンパイルする関数をフックすることにより、GoogleMapで使用されるすべてのシェーダを書き換えられるように変更した。  
また、GoogleMapのシェーダは、同一のソースコードでも、複数回コンパイルされることがある。  
これはシェーダ内に存在する`#ifdef XXX`などを有効にしたり無効にしたりするためである。  
これを用いて建物を3D描画しているシェーダを書き換えた。  
建物を表示しているシェーダは2回コンパイルされる。  
1つ目のシェーダは「カメラの画角が真下から45度までの範囲のとき」という条件で使用される。  
2つ目のシェーダは「カメラの画角が水平線から45度までの範囲のとき」という条件で使用される。  
1つ目のシェーダには先頭に`#define_a;`という行が追加されており、これにより`#ifdef _a`内にある`uniform mat4 u;`という変数が有効になる。  
この変数は`attribute`で与えられる頂点を地球の中心を原点とした座標に変換するための行列である。  
どちらのシェーダを使用するかは`isVisible`関数が返す値によって切り替えられている。  
そのため、`isVisible`関数を書き換えることにより、シェーダ2のみを使用するように変更した。  

## 3. 任意のuniform変数を更新できるように変更
GoogleMapはレンダリングを行うときに`drawElement`関数を用いる。  
その関数が呼ばれている少し前の行に、こちらが定義した関数を呼ばせるように変更した。  
これにより、レンダリングする直前のタイミングで`uniform`変数の更新が行えるようになった。  
